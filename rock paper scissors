import random
import time

VALID_INPUTS = {
    "r": "rock",
    "rock": "rock",
    "p": "paper",
    "paper": "paper",
    "s": "scissors",
    "scissors": "scissors"
}

WIN_MAP = {
    "rock": ["scissors"],
    "paper": ["rock"],
    "scissors": ["paper"]
}

def normalize_input(user_input):
    return VALID_INPUTS.get(user_input.strip().lower())

def get_computer_choice(difficulty, player_last_move=None):
    if difficulty == "easy" or player_last_move is None:
        return random.choice(list(WIN_MAP.keys()))

    if difficulty == "medium":
        if random.random() < 0.6:
            return counter_move(player_last_move)
        return random.choice(list(WIN_MAP.keys()))

    if difficulty == "hard":
        return counter_move(player_last_move)

def counter_move(move):
    for key, beats in WIN_MAP.items():
        if move in beats:
            return key
    return random.choice(list(WIN_MAP.keys()))

def determine_winner(player, computer):
    if player == computer:
        return "tie"
    if computer in WIN_MAP[player]:
        return "player"
    return "computer"

def choose_best_of():
    while True:
        choice = input("Choose match length (3 / 5 / 7): ").strip()
        if choice in {"3", "5", "7"}:
            return int(choice)

def choose_difficulty():
    while True:
        diff = input("Choose difficulty (easy / medium / hard): ").lower().strip()
        if diff in {"easy", "medium", "hard"}:
            return diff

def play_game():
    print("\nWelcome to Rock Paper Scissors\n")

    best_of = choose_best_of()
    difficulty = choose_difficulty()

    wins_needed = best_of // 2 + 1
    player_score = 0
    computer_score = 0
    round_number = 1
    last_player_move = None

    print(f"\nFirst to {wins_needed} wins. Difficulty: {difficulty.capitalize()}\n")

    while player_score < wins_needed and computer_score < wins_needed:
        print(f"Round {round_number}")
        player_raw = input("Your move (r/p/s or rock/paper/scissors): ")
        player_move = normalize_input(player_raw)

        if not player_move:
            print("Invalid input. Try again.\n")
            continue

        computer_move = get_computer_choice(difficulty, last_player_move)
        last_player_move = player_move

        print(f"You chose: {player_move}")
        print(f"Computer chose: {computer_move}")
        time.sleep(0.5)

        result = determine_winner(player_move, computer_move)

        if result == "tie":
            print("It's a tie.\n")
        elif result == "player":
            player_score += 1
            print("You win this round.\n")
        else:
            computer_score += 1
            print("Computer wins this round.\n")

        print(f"Score â€” You: {player_score} | Computer: {computer_score}\n")
        round_number += 1

    print("Match over.")
    if player_score > computer_score:
        print("You won the match. Well played.")
    else:
        print("Computer wins the match. Learn from it.")

if __name__ == "__main__":
    play_game()
